name: Android CI

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'bugfix/**'
      - 'hotfix/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'README.md'
      - 'CLAUDE.md'
  pull_request:
    branches:
      - main
      - develop
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'README.md'
      - 'CLAUDE.md'

permissions:
  contents: read
  checks: write

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Validate Gradle wrapper
        uses: gradle/actions/wrapper-validation@v4

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # Cache strategy:
      # - main/develop branches: read and write cache
      # - feature branches: read-only cache
      # This prevents cache pollution from feature branches
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}

      - name: Build Debug Variants
        run: ./gradlew assembleDebug

      - name: Build Release Variants
        run: ./gradlew assembleRelease

      - name: Verify Charge SDK Release Build
        run: |
          if [ ! -f "charge/build/outputs/aar/charge-release.aar" ]; then
            echo "❌ Charge SDK release AAR not found!"
            exit 1
          fi
          echo "✅ Charge SDK release build successful"
          echo "## Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Charge Library (SDK)" >> $GITHUB_STEP_SUMMARY
          ls -lh charge/build/outputs/aar/ | tail -n +2 | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### App Module" >> $GITHUB_STEP_SUMMARY
          ls -lh app/build/outputs/apk/debug/ 2>/dev/null | tail -n +2 | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY || echo "- No debug APK" >> $GITHUB_STEP_SUMMARY

      - name: Upload build outputs
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: |
            **/build/outputs/aar/
            **/build/outputs/apk/
          retention-days: 1

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # Cache strategy:
      # - main/develop branches: read and write cache
      # - feature branches: read-only cache
      # This prevents cache pollution from feature branches
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}

      - name: Run Tests with Gradle
        run: ./gradlew test

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            **/build/test-results/test*/*.xml
            **/build/reports/tests/
          retention-days: 14

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -d "charge/build/test-results/testDebugUnitTest" ]; then
            TEST_COUNT=$(find charge/build/test-results/testDebugUnitTest -name "*.xml" | wc -l)
            echo "✅ Charge module: $TEST_COUNT test files" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d "app/build/test-results/testDebugUnitTest" ]; then
            TEST_COUNT=$(find app/build/test-results/testDebugUnitTest -name "*.xml" | wc -l)
            echo "✅ App module: $TEST_COUNT test files" >> $GITHUB_STEP_SUMMARY
          fi

  lint:
    name: Android Lint
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # Cache strategy:
      # - main/develop branches: read and write cache
      # - feature branches: read-only cache
      # This prevents cache pollution from feature branches
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}

      - name: Run Android Lint
        run: ./gradlew :charge:lintDebug :app:lintDebug
        continue-on-error: true

      - name: Upload Lint Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-reports
          path: |
            charge/build/reports/lint-results-*.html
            charge/build/reports/lint-results-*.xml
            app/build/reports/lint-results-*.html
            app/build/reports/lint-results-*.xml
          retention-days: 14

  detekt:
    name: Detekt
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v5

      - name: Set up JDK 21
        uses: actions/setup-java@v5
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: gradle

      # Cache strategy:
      # - main/develop branches: read and write cache
      # - feature branches: read-only cache
      # This prevents cache pollution from feature branches
      - name: Set up Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop' }}

      - name: Run Detekt
        run: ./gradlew detekt
        continue-on-error: true

      - name: Upload Detekt Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: detekt-reports
          path: |
            build/reports/detekt/
            app/build/reports/detekt/
            charge/build/reports/detekt/
          retention-days: 14
