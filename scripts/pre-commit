#!/bin/bash
#
# Pre-commit hook for Android project
# Runs lint and Detekt checks before allowing commits
#
# To bypass this hook in emergencies, use: git commit --no-verify
#

set -e

echo "ğŸ” Running pre-commit checks..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if there are Kotlin files being committed
KOTLIN_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.kt$" || true)
GRADLE_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep "\.gradle\|\.gradle.kts$" || true)

if [ -z "$KOTLIN_FILES" ] && [ -z "$GRADLE_FILES" ]; then
    echo "â„¹ï¸  No Kotlin or Gradle files changed, skipping checks"
    exit 0
fi

# Track if any checks fail
CHECKS_FAILED=0

# Run Detekt on changed files
if [ -n "$KOTLIN_FILES" ]; then
    echo "ğŸ“‹ Running Detekt on changed files..."
    if ./gradlew detekt | grep -q "Analysis failed"; then
        echo -e "${RED}âŒ Detekt found issues${NC}"
        echo ""
        echo "Run './gradlew detekt' to see details"
        echo "Review and fix issues in:"
        echo "$KOTLIN_FILES" | sed 's/^/  - /'
        CHECKS_FAILED=1
    else
        echo -e "${GREEN}âœ… Detekt passed${NC}"
    fi
    echo ""
fi

# Run lint on charge module (main SDK)
echo "ğŸ” Running Android Lint on charge module..."
if ! ./gradlew :charge:lintDebug --quiet > /dev/null 2>&1; then
    echo -e "${RED}âŒ Lint found issues in charge module${NC}"
    echo ""
    echo "Run './gradlew :charge:lintDebug' to see details"
    echo "Review: charge/build/reports/lint-results-debug.html"
    CHECKS_FAILED=1
else
    echo -e "${GREEN}âœ… Lint passed for charge module${NC}"
fi
echo ""

# Run lint on app module (if app files changed)
APP_FILES=$(echo "$KOTLIN_FILES" | grep "^app/" || true)
if [ -n "$APP_FILES" ]; then
    echo "ğŸ” Running Android Lint on app module..."
    if ! ./gradlew :app:lintDebug --quiet > /dev/null 2>&1; then
        echo -e "${RED}âŒ Lint found issues in app module${NC}"
        echo ""
        echo "Run './gradlew :app:lintDebug' to see details"
        echo "Review: app/build/reports/lint-results-debug.html"
        CHECKS_FAILED=1
    else
        echo -e "${GREEN}âœ… Lint passed for app module${NC}"
    fi
    echo ""
fi

# Check results
if [ $CHECKS_FAILED -eq 1 ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ Pre-commit checks FAILED${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "Please fix the issues above before committing."
    echo ""
    echo -e "${YELLOW}ğŸ’¡ Tips:${NC}"
    echo "  â€¢ Run './gradlew detekt' to see Detekt issues"
    echo "  â€¢ Run './gradlew :charge:lintDebug' for lint issues"
    echo "  â€¢ Check HTML reports in build/reports/ directories"
    echo "  â€¢ Use 'git commit --no-verify' to bypass (emergencies only)"
    echo ""
    exit 1
fi

echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

exit 0
